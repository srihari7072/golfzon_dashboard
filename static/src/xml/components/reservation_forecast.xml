<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="golfzon_dashboard.ReservationForecast">
        <div class="reservation-forecast-section">
            <t t-call="golfzon_dashboard.SectionHeader">
                <t t-set="sectionTitle" t-value="_t('Reservation Status')"/>
                <t t-set="analysisPeriod" t-value="state.forecastData.analysis_period"/>
            </t>
            <div class="forecast-main-layout">
                <!-- Left Side - Line Graph -->
                <t t-call="golfzon_dashboard.ReservationTrendChart"/>
                <!-- Right Side - Fixed Layout Heatmap -->
                <t t-call="golfzon_dashboard.FixedHeatmapLayout"/>
            </div>
        </div>
    </t>
    <t t-name="golfzon_dashboard.ReservationTrendChart">
        <div class="forecast-left-side">
            <div class="line-chart-card">
                <!-- ðŸ”§ FIXED: Use direct markup instead of template call -->
                <div class="chart-header">
                    <div class="chart-title-section">
                        <div class="title-with-tooltip">
                            <h3>
                                <t t-esc="_t('Reservation Trend by Period')"/>
                            </h3>
                            <div class="tooltip-wrapper">
                                <span class="help-icon">
                                    <img src="/golfzon_dashboard/static/src/img/help-icon.svg" alt="Help"/>
                                </span>
                                <div class="tooltip-content">
                                    <t t-if="state.reservationPeriod === '7days'" t-esc="_t('7 Days Before the Reference Date')"/>
                                    <t t-else="" t-esc="_t('30 Days Before the Reference Date')"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="time-period-buttons">
                        <button class="period-btn" t-att-class="{'active': state.reservationPeriod === '7days'}" t-on-click="() => this.updateReservationChart('7days')">
                            <t t-esc="_t('Last 7 Days')"/>
                        </button>
                        <button class="period-btn" t-att-class="{'active': state.reservationPeriod === '30days'}" t-on-click="() => this.updateReservationChart('30days')">
                            <t t-esc="_t('Last 30 Days')"/>
                        </button>
                    </div>
                </div>
                <div class="line-chart-container">
                    <canvas t-ref="reservationTrendChart"/>
                </div>
                <!-- Stats Cards -->
                <div class="stats-cards-below">
                    <div class="stat-card horizontal">
                        <div class="stat-info">
                            <span class="stat-label">
                                <t t-esc="_t('Total number of reservations')"/>
                                <span class="tooltip-wrapper">
                                    <span class="help-icon">
                                        <img src="/golfzon_dashboard/static/src/img/help-icon.svg" alt="Help"/>
                                    </span>
                                    <div class="tooltip-content">
                                        <t t-esc="_t('Total Number of Reservations Based on Visit Date')"/>
                                    </div>
                                </span>
                            </span>
                            <div class="stat-value">
                                <t t-esc="state.reservationData?.total_reservations?.toLocaleString() || '0'"/>
                            </div>
                        </div>
                        <div class="stat-comparison">
                            <span class="comparison-label">
                                <t t-esc="_t('compared to same period last year')"/>
                            </span>
                            <span class="trend-indicator" t-att-class="state.reservationData.percentage_change >= 0 ? 'trend-up' : 'trend-down'">
                                <span class="trend-icon">
                                    <t t-if="state.reservationData.percentage_change >= 0">
                                        <img src="/golfzon_dashboard/static/src/img/trend-up.svg" alt="Up" class="trend-arrow"/>
                                    </t>
                                    <t t-else="">
                                        <img src="/golfzon_dashboard/static/src/img/trend-down.svg" alt="Down" class="trend-arrow"/>
                                    </t>
                                </span>
                                <span>
                                    <t t-if="state.reservationData.percentage_change >= 0">+</t>
                                    <t t-else="">-</t>
                                    <t t-esc="Math.abs(state.reservationData.percentage_change).toFixed(1)"/>%
                                </span>
                            </span>
                        </div>
                    </div>
                    <div class="stat-card horizontal">
                        <div class="stat-info">
                            <span class="stat-label">
                                <t t-esc="_t('Total Operation rate')"/>
                                <div class="tooltip-wrapper">
                                    <span class="help-icon">
                                        <img src="/golfzon_dashboard/static/src/img/help-icon.svg" alt="Help"/>
                                    </span>
                                    <div class="tooltip-content">
                                        <t t-esc="_t('Ratio of Reserved Tee Times to Total Operating Tee Times')"/>
                                    </div>
                                </div>
                            </span>
                            <div class="stat-value">
                                <span class="operation-rate">
                                    <t t-set="avgRate" t-value="((state.reservationData?.operation_rate?.part1_percentage || 0) + (state.reservationData?.operation_rate?.part2_percentage || 0) + (state.reservationData?.operation_rate?.part3_percentage || 0)) / 3"/>
                                    <t t-esc="avgRate.toFixed(1)"/>%
                                </span>
                            </div>
                        </div>
                        <div class="stat-breakdown horizontal-parts">
                            <span>
                                <span class="part-label">
                                    <t t-esc="_t('Part 1 ')"/>
                                </span>
                                <t t-esc="state.reservationData?.operation_rate?.part1_percentage?.toFixed(1) || '0.0'"/>%
                            </span>
                            <span>
                                <span class="part-label">
                                    <t t-esc="_t('Part 2 ')"/>
                                </span>
                                <t t-esc="state.reservationData?.operation_rate?.part2_percentage?.toFixed(1) || '0.0'"/>%
                            </span>
                            <span>
                                <span class="part-label">
                                    <t t-esc="_t('Part 3 ')"/>
                                </span>
                                <t t-esc="state.reservationData?.operation_rate?.part3_percentage?.toFixed(1) || '0.0'"/>%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
    <!-- ðŸ†• FIXED: No-shift layout with always-visible sidebar -->
    <t t-name="golfzon_dashboard.FixedHeatmapLayout">
        <div class="forecast-right-side">
            <!-- Fixed Container with Heatmap and Sidebar -->
            <div class="reservation-trends-section">
                <!-- Main Heatmap Layout with header inside -->
                <div class="heatmap-main-layout">
                    <!-- Left: Heatmap Grid -->
                    <div class="heatmap-grid-section">
                        <!-- Header Inside the card -->
                        <div class="heatmap-header-section">
                            <h3 class="heatmap-title">
                                <t t-esc="_t('Reservation Trend')"/>
                            </h3>
                        </div>
                        <!-- Days Header -->
                        <div class="heatmap-days-header">
                            <div class="time-label-spacer"></div>
                            <t t-foreach="state.heatmapData.headers" t-as="day" t-key="day">
                                <div class="day-header" t-esc="day"/>
                            </t>
                        </div>
                        <!-- Heatmap Grid -->
                        <div class="heatmap-grid-container">
                            <t t-foreach="state.heatmapData.rows" t-as="timeRow" t-key="timeRow_index">
                                <div class="heatmap-row">
                                    <div class="time-row-label"><t t-esc="timeRow.label"/></div>
                                    <div class="heatmap-boxes-row">
                                        <t t-foreach="timeRow.data" t-as="value" t-key="value_index">
                                            <div class="heatmap-box"
                                                t-att-class="this.getHeatmapCellClass(value)"
                                                t-att-data-day-index="value_index"
                                                t-att-data-time-index="timeRow_index"
                                                t-att-data-value="value"
                                                t-on-click="(ev) => this.selectHeatmapBox({
                                                    dayIndex: value_index,
                                                    timeIndex: timeRow_index,
                                                    value: value,
                                                    day: state.heatmapData.headers[value_index],
                                                    timeSlot: timeRow.label
                                                }, ev)">
                                                <span class="box-value" t-esc="value"/>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </t>
                        </div>
                        <!-- Legend Section (below the 28 boxes) -->
                        <div class="heatmap-legend-section">
                            <div class="heatmap-legend">
                                <div class="legend-item">
                                    <div class="legend-dot top-20"></div>
                                    <span>
                                        <t t-esc="_t('Top 20%')"/>
                                    </span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot top-20-40"></div>
                                    <span>
                                        <t t-esc="_t('Top 20-40%')"/>
                                    </span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot median-20"></div>
                                    <span>
                                        <t t-esc="_t('Median 20%')"/>
                                    </span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot bottom-20-40"></div>
                                    <span>
                                        <t t-esc="_t('Bottom 20-40%')"/>
                                    </span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot bottom-20"></div>
                                    <span>
                                        <t t-esc="_t('Bottom 20%')"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right: Details Sidebar -->
                    <div class="heatmap-details-sidebar">
                        <!-- Default content when no box is selected -->
                        <div class="sidebar-default-content" t-if="!state.selectedHeatmapBox.isVisible">
                            <div class="default-message">
                                <div class="default-title">
                                    <t t-esc="_t('When selecting the cell on the right')"/>
                                </div>
                                <div class="default-title">
                                    <t t-esc="_t('The number of reserved teams by time slot for that cell')"/>
                                </div>
                                <div class="default-title">
                                    <t t-esc="_t('can be checked.')"/>
                                </div>
                            </div>
                        </div>
                        <!-- Selected box details -->
                        <div class="sidebar-selected-content" t-if="state.selectedHeatmapBox.isVisible">
                            <!-- Alert Messages -->
                            <div class="alert-message-section">
                                <div class="alert-message highest" t-if="state.selectedHeatmapBox.isHighest">
                                    <span class="alert-badge">
                                        <img src="/golfzon_dashboard/static/src/img/highest_booking_icon.svg" alt="Highest" class="alert-icon-img" />
                                    </span>
                                    <span class="alert-text">
                                        <t t-esc="_t('This is the time slot with the most bookings')"/>
                                    </span>
                                </div>
                                <div class="alert-message lowest" t-if="state.selectedHeatmapBox.isLowest">
                                    <span class="alert-badge">
                                        <img src="/golfzon_dashboard/static/src/img/least_booking_icon.svg" alt="least" class="alert-icon-img" />
                                    </span>
                                    <span class="alert-text">
                                        <t t-esc="_t('This is the time slot with the fewest bookings')"/>
                                    </span>
                                </div>
                            </div>
                            <!-- Sidebar Header (no duplicate day, no timeslot) -->
                            <div class="sidebar-header-section">
                                <h2 class="sidebar-title" t-esc="state.selectedHeatmapBox.combinedTitle"/>
                                <p class="sidebar-subtitle">
                                    <t t-esc="_t('Number of reservations by time zone')"/>
                                </p>
                            </div>
                            <!-- Hourly Breakdown in Columns -->
                            <div class="hourly-breakdown-section">
                                <div class="hourly-columns-row">
                                    <!-- Top Row: First 5 time slots -->
                                    <div class="hourly-row-top">
                                        <t t-foreach="state.selectedHeatmapBox.hourlyBreakdown.slice(0, 5)" 
                                        t-as="hourSlot" 
                                        t-key="hourSlot_index + '_top'">
                                            <div class="hourly-column">
                                                <div class="time-header" t-esc="hourSlot.hour"/>
                                                <div class="team-value" t-esc="hourSlot.teams"/>
                                            </div>
                                        </t>
                                    </div>
                                    <!-- Bottom Row: Next 5 time slots -->
                                    <div class="hourly-row-bottom" t-if="state.selectedHeatmapBox.hourlyBreakdown.length > 5">
                                        <t t-foreach="state.selectedHeatmapBox.hourlyBreakdown.slice(5, 10)" 
                                        t-as="hourSlot" 
                                        t-key="hourSlot_index + '_bottom'">
                                            <div class="hourly-column">
                                                <div class="time-header" t-esc="hourSlot.hour"/>
                                                <div class="team-value" t-esc="hourSlot.teams"/>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bottom Half - Pie Charts -->
            <t t-call="golfzon_dashboard.PieChartsCard"/>
        </div>
    </t>
    <!-- Pie Charts Section -->
    <t t-name="golfzon_dashboard.PieChartsCard">
        <div class="pie-charts-card">
            <div class="pie-charts-header">
                <h3>
                    <t t-esc="_t('Reservation Member Composition Status')"/>
                </h3>
            </div>
            <div class="pie-charts-grid">
                <!-- Member Type Chart -->
                <div class="pie-chart-item">
                    <div class="chart-and-legend">
                        <div class="pie-chart-and-title-wrapper">
                            <div class="pie-chart-wrapper">
                                <canvas t-ref="memberTypeChart"/>
                            </div>
                            <div class="chart-title-wrapper">
                                <div class="chart-title">
                                    <t t-esc="_t('Reservation Proportion by Type')"/>
                                </div>
                            </div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot individual"></span>
                                    <span>
                                        <t t-esc="_t('Individual')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_type?.individual?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot joint"></span>
                                    <span>
                                        <t t-esc="_t('Joint Organization')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_type?.joint_organization?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot general"></span>
                                    <span>
                                        <t t-esc="_t('General Organization')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_type?.general_organization?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot temporary"></span>
                                    <span>
                                        <t t-esc="_t('Temporary Organization')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_type?.temporary_organization?.percentage || 0"/>%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Advance Booking Chart -->
                <div class="pie-chart-item">
                    <div class="chart-and-legend">
                        <div class="pie-chart-and-title-wrapper">
                            <div class="pie-chart-wrapper">
                                <canvas t-ref="advanceBookingChart"/>
                            </div>
                            <div class="chart-title-wrapper">
                                <div class="chart-title">
                                    <t t-esc="_t('Reservation Proportion by Time')"/>
                                </div>
                            </div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot d15"></span>
                                    <span>D-15+</span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_time?.d15_plus?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot d14"></span>
                                    <span>D-14</span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_time?.d14?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot d7"></span>
                                    <span>D-7</span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_time?.d7?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot d3"></span>
                                    <span>D-3</span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_time?.d3?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot d1"></span>
                                    <span>D-1</span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_time?.d1?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot d0"></span>
                                    <span>D-0</span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_time?.d0?.percentage || 0"/>%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Regional Distribution Chart -->
                <div class="pie-chart-item">
                    <div class="chart-and-legend">
                        <div class="pie-chart-and-title-wrapper">
                            <div class="pie-chart-wrapper">
                                <canvas t-ref="regionalChart"/>
                            </div>
                            <div class="chart-title-wrapper">
                                <div class="chart-title">
                                    <t t-esc="_t('Reservation Proportion by Channel')"/>
                                </div>
                            </div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot phone"></span>
                                    <span>
                                        <t t-esc="_t('Phone')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_channel?.phone?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot internet"></span>
                                    <span>
                                        <t t-esc="_t('Internet')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_channel?.internet?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot agency1"></span>
                                    <span>
                                        <t t-esc="_t('Agency')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_channel?.agency?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot agent"></span>
                                    <span>
                                        <t t-esc="_t('Agent')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_channel?.agent?.percentage || 0"/>%
                                </span>
                            </div>
                            <div class="legend-entry">
                                <div class="legend-label">
                                    <span class="dot other"></span>
                                    <span>
                                        <t t-esc="_t('Others')"/>
                                    </span>
                                </div>
                                <span class="legend-value">
                                    <t t-esc="state.memberCompositionData?.by_channel?.others?.percentage || 0"/>%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>